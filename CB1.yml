---
- name: Health Check for Linux and Windows Nodes
  hosts: all
  gather_facts: true

  tasks:
    # =========================
    # Task Block for each host
    # =========================
    - name: Per-host resource collection and fact setting
      block:
        # These tasks run once per host in the inventory
        - name: Set OS family fact
          set_fact:
            os_family: "{{ ansible_facts['os_family'] }}"

        # ... (all your resource collection tasks for Linux and Windows go here) ...
        - name: Collect resource metrics based on OS
          block:
            - when: os_family == "RedHat"
              block:
                - name: Get CPU usage (Linux)
                  shell: top -bn1 | grep "Cpu(s)" | awk '{print 100 - $8}'
                  register: linux_cpu
                  changed_when: false
                - name: Get Memory usage (Linux)
                  shell: free | awk '/Mem:/ {print ($3/$2) * 100}'
                  register: linux_mem
                  changed_when: false
                - name: Get Disk usage (Linux)
                  shell: df / | awk 'NR==2 {print $5}' | sed 's/%//'
                  register: linux_disk
                  changed_when: false
            - when: os_family == "Windows"
              block:
                - name: Get CPU usage (Windows)
                  win_shell: '[math]::Round((Get-Counter "\Processor(_Total)\% Processor Time").CounterSamples.CookedValue, 2)'
                  register: win_cpu
                  changed_when: false
                - name: Get Memory usage (Windows)
                  win_shell: |
                    $mem = Get-CimInstance Win32_OperatingSystem
                    [math]::Round((($mem.TotalVisibleMemorySize - $mem.FreePhysicalMemory) / $mem.TotalVisibleMemorySize) * 100, 2)
                  register: win_mem
                  changed_when: false
                - name: Get Disk usage (Windows)
                  win_shell: |
                    $disk = Get-CimInstance Win32_LogicalDisk -Filter "DeviceID='C:'"
                    [math]::Round((($disk.Size - $disk.FreeSpace) / $disk.Size) * 100, 2)
                  register: win_disk
                  changed_when: false

        - name: Unify resource values and determine status
          set_fact:
            cpu: "{{ (os_family == 'RedHat') | ternary(linux_cpu.stdout, win_cpu.stdout) | float | round(2) }}"
            ram: "{{ (os_family == 'RedHat') | ternary(linux_mem.stdout, win_mem.stdout) | float | round(2) }}"
            disk: "{{ (os_family == 'RedHat') | ternary(linux_disk.stdout, win_disk.stdout) | float | round(2) }}"
            status: "{{ 'CRITICAL' if cpu > 60 or ram > 60 or disk > 60 else 'GOOD' }}"
      # End of the per-host block

# ================================
# Final Logging Task (runs only ONCE)
# ================================
- name: Generate and save final report to artifacts
  hosts: localhost # This makes the play target the control node directly
  connection: local
  gather_facts: false
  run_once: true # Ensures this entire play runs only a single time

  tasks:
    - name: Assemble report from all hosts
      delegate_to: localhost
      blockinfile:
        path: "{{ hostvars[ansible_play_hosts[0]]['ansible_runner_artifacts_dir'] }}/node_health_check.log"
        create: yes
        mode: '0644'
        marker: "# --- Report generated on {now(utc, '%Y-%m-%d %H:%M:%S UTC')} ---"
        block: |
          {% for host in ansible_play_hosts_all %}
          {{ hostvars[host].inventory_hostname }} | OS: {{ hostvars[host].os_family | default('N/A') }} | CPU: {{ hostvars[host].cpu | default('N/A') }}% | RAM: {{ hostvars[host].ram | default('N/A') }}% | Disk: {{ hostvars[host].disk | default('N/A') }}% | STATUS: {{ hostvars[host].status | default('FAILED_TO_GATHER') }}
          {% endfor %}
